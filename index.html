<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asignaciones BK</title>
  <style>
    /* tu CSS aquí igual */
    body {
      font-family: Arial, sans-serif;
      background-color: #b0acd4;
      color: #6755a2;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      text-align: center;
    }
    h1 {
      color: #46245c;
    }
    input, select, button {
      padding: 0.5rem;
      margin: 0.5rem;
      border: 1px solid #6755a2;
      border-radius: 8px;
      font-size: 1rem;
    }
    button {
      background-color: #6755a2;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #46245c;
    }
    .tabla {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      margin-top: 2rem;
      width: 90%;
      max-width: 600px;
      padding: 1rem;
      opacity: 0;
      transform: scale(0.9);
      animation: aparecer 0.6s forwards ease-out;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.5rem;
      border-bottom: 1px solid #ccc;
    }
    @keyframes aparecer {
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    .contador {
      font-weight: bold;
      margin-top: 1rem;
    }
    .error {
      color: #b00020;
      font-weight: bold;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h1>Asignaciones BK</h1>

  <select id="modo" aria-label="Modo de visualización">
    <option value="mias">Ver mis horarios</option>
    <option value="todos">Ver horarios de todos</option>
  </select>

  <div id="form-legajo">
    <input type="text" id="legajo" placeholder="Ingresá tu legajo" aria-label="Legajo" />
    <button type="button" onclick="buscarAsignaciones()">Ver mis horarios</button>
    <div id="error-legajo" class="error" style="display:none;"></div>
  </div>

  <div id="tabla-asignaciones" class="tabla" style="display:none;" aria-live="polite"></div>

  <script>
    const API_BASE_URL = "https://bitter-scene-e2f5.milibarraza18.workers.dev/api/";

    // URL CSV de Google Sheets (revisá que esté publicada y pública)
    const GOOGLE_SHEETS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRbyYnTDk6oZnYZ1JZznd9oOSrw_2slT9CkYR4mVDKAorMln3NXIPcjEreGI_NvdpDmavIIIBXPdfq/pub?output=csv&gid=0";

    // Variables globales para legajos y nombres que cargaremos del CSV
    let legajosNombres = []; // Array de objetos { legajo: "123", nombre: "Juan" }

    const modoSelect = document.getElementById('modo');
    const formLegajo = document.getElementById('form-legajo');
    const errorLegajo = document.getElementById('error-legajo');
    const tablaAsignaciones = document.getElementById('tabla-asignaciones');

    // Escuchar cambio modo
    modoSelect.addEventListener('change', () => {
      errorLegajo.style.display = 'none';
      tablaAsignaciones.style.display = 'none';

      if (modoSelect.value === 'mias') {
        formLegajo.style.display = 'block';
      } else {
        formLegajo.style.display = 'none';
        mostrarTodos();
      }
    });

    // Función para parsear CSV simple (asume primera fila encabezados legajo,nombre)
    function parseCSV(text) {
      const lines = text.trim().split("\n");
      const result = [];
      const headers = lines[0].split(",").map(h => h.trim().toLowerCase());

      for (let i = 1; i < lines.length; i++) {
        const obj = {};
        const currentline = lines[i].split(",");

        headers.forEach((header, idx) => {
          obj[header] = currentline[idx] ? currentline[idx].trim() : "";
        });

        result.push(obj);
      }
      return result;
    }

    // Cargar legajos y nombres desde Google Sheets CSV
    async function cargarLegajosNombres() {
      try {
        const res = await fetch(GOOGLE_SHEETS_CSV_URL);
        if (!res.ok) throw new Error("No se pudo cargar la planilla");
        const csvText = await res.text();
        legajosNombres = parseCSV(csvText).filter(row => row.legajo && row.nombre);
      } catch (e) {
        console.error("Error cargando planilla:", e);
        legajosNombres = []; // fallback vacío
      }
    }

    async function buscarAsignaciones() {
      errorLegajo.style.display = 'none';
      tablaAsignaciones.style.display = 'none';

      const legajo = document.getElementById("legajo").value.trim();
      if (!legajo) {
        errorLegajo.textContent = "Ingresá un legajo.";
        errorLegajo.style.display = 'block';
        return;
      }

      tablaAsignaciones.innerHTML = "Cargando...";
      tablaAsignaciones.style.display = 'block';

      try {
        const res = await fetch(API_BASE_URL + `asignaciones/legajos/${legajo}`);
        if (!res.ok) throw new Error("Error en la respuesta de la API");
        const data = await res.json();

        if (!data.asignaciones || data.asignaciones.length === 0) {
          tablaAsignaciones.innerHTML = `<p>No se encontraron asignaciones para el legajo ${legajo}.</p>`;
          return;
        }

        // Buscar nombre en legajosNombres
        const nombre = (legajosNombres.find(e => e.legajo === legajo) || {}).nombre || "Sin nombre";

        mostrarTabla(data.asignaciones, `Horarios para ${legajo} (${nombre})`, true);
      } catch (e) {
        tablaAsignaciones.innerHTML = `<p class="error">No se pudieron cargar los datos. Intenta nuevamente.</p>`;
      }
    }

    async function mostrarTodos() {
      tablaAsignaciones.innerHTML = "Cargando...";
      tablaAsignaciones.style.display = 'block';

      if (legajosNombres.length === 0) {
        // Si no cargamos aún, cargamos legajos y nombres
        await cargarLegajosNombres();
      }

      if (legajosNombres.length === 0) {
        tablaAsignaciones.innerHTML = "<p class='error'>No se pudo cargar la lista de legajos.</p>";
        return;
      }

      const todas = [];

      for (const item of legajosNombres) {
        const legajo = item.legajo;
        const nombre = item.nombre;

        try {
          const res = await fetch(API_BASE_URL + `asignaciones/legajos/${legajo}`);
          if (!res.ok) continue;
          const data = await res.json();

          if (data.asignaciones && data.asignaciones.length > 0) {
            data.asignaciones.forEach(asig => {
              todas.push({
                ...asig,
                nombre,
              });
            });
          }
        } catch {
          // omitimos errores individuales
        }
      }

      if (todas.length === 0) {
        tablaAsignaciones.innerHTML = "<p>No se encontraron asignaciones para mostrar.</p>";
        return;
      }

      // Ordenar por fecha y hora de entrada
      todas.sort((a, b) => {
        const fechaHoraA = a.fecha + " " + a.horaEntrada;
        const fechaHoraB = b.fecha + " " + b.horaEntrada;
        return fechaHoraA.localeCompare(fechaHoraB);
      });

      mostrarTabla(todas, "Horarios de todos", false);
    }

    function calcularHoras(entrada, salida) {
      const [h1, m1] = entrada.split(":").map(Number);
      const [h2, m2] = salida.split(":").map(Number);

      if (isNaN(h1) || isNaN(m1) || isNaN(h2) || isNaN(m2)) return 0;

      let minutosEntrada = h1 * 60 + m1;
      let minutosSalida = h2 * 60 + m2;

      if (minutosSalida < minutosEntrada) {
        minutosSalida += 24 * 60;
      }

      return (minutosSalida - minutosEntrada) / 60;
    }

    function mostrarTabla(asignaciones, titulo, mostrarContador) {
      let html = `<h2>${titulo}</h2><table aria-label="Tabla de asignaciones"><thead><tr>
        <th>Fecha</th><th>Entrada
